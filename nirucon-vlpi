#!/bin/bash

# Nirucon-VLPI: Post Install script for Void Linux
# Author: Nicklas Rudolfsson
# Version: 2024-08-03
# License: Feel free to use and modify, donate if you want :) https://www.paypal.com/paypalme/nicklasrudolfsson
# Disclaimer: I do not have any responsibility at all for this script and changes on your system!

# Function: Check for internet connection
check_internet_connection() {
    if ping -q -c 1 -W 1 google.com >/dev/null; then
        echo -e "\e[32mInternet connection: OK\e[0m"
    else
        echo -e "\e[31mInternet connection: DOWN\e[0m"
        echo "This script requires an active internet connection. Please resolve the issue and run the script again."
        exit 1
    fi
}

# Function: Display welcome message
display_welcome() {
    clear
    echo -e "\e[1;34mWelcome to the Nirucon-VLPI Post Install script for Void Linux\e[0m"
    echo -e "\e[1;31mDisclaimer: Use at your own risk. The author does not have any responsibility at all for this script and changes on your system!\e[0m"
    echo "--------------------------------------------------------------------------"
}

# Function: Prompt confirmation to proceed
confirm_proceed() {
    read -p "Are you sure you want to continue with the post installation on your Void Linux? [Y/n]: " confirm_install
    confirm_install="${confirm_install,,}" # Convert to lowercase
    if [[ "$confirm_install" == "n" ]]; then
        echo "Installation aborted."
        exit 0
    fi
    echo "Proceeding with installation..."
}

# Function: Install repos
install_repos() {
    echo "Adding nonfree repository..."

    # Update package list and install nonfree repository
    sudo xbps-install -Syu
    sudo xbps-install -y void-repo-nonfree

    echo "Nonfree repository and tools installed successfully."
}

# Function: Install core dependencies for suckless (dwm, st, dmenu, slock), minimal Xorg setup and essential packages
install_core_suckless() {
    echo "Installing core dependencies for suckless, minimal Xorg setup and some essential packages..."

    # Update package list and install core dependencies
    sudo xbps-install -Syu
    sudo xbps-install -y base-devel libX11-devel libXft-devel libXinerama-devel \
        libXrandr-devel imlib2-devel freetype-devel fontconfig-devel xorg-minimal \
        xorg-fonts xsetroot setxkbmap xrdb nano unzip wget nitrogen picom alsa-utils \
        cmus mpc wpa_supplicant NetworkManager calcurse xbacklight connman curl dunst \
        pamixer spotifyd playerctl jq
    
    echo -e "\e[32mCore dependencies for suckless, minimal Xorg setup, and essential packages installed!\e[0m"
}

# Function: Clone and install nirucon-suckless and related files, scripts, and dot files
install_suckless() {
    echo "Installing nirucon-suckless, configurations and scripts..."
    mkdir -p ~/Git && git clone https://github.com/nirucon/nirucon-suckless ~/Git/nirucon-suckless
    mkdir -p ~/.config/suckless ~/.dwm ~/Music ~/Downloads ~/Pictures ~/Videos ~/Temp ~/.config/dunst

    declare -a repos=("nirubar-dwm-void" "dunstrc" "srplay-dmenu" "dwmexit-dmenu" "havamal")
    for repo in "${repos[@]}"; do
        rm -rf ~/Git/$repo
        git clone https://github.com/nirucon/$repo ~/Git/$repo
    done

    cp -rf ~/Git/nirubar-dwm-void/ ~/Git/nirucon-suckless/dmenu ~/Git/nirucon-suckless/st ~/Git/nirucon-suckless/slock ~/Git/nirucon-suckless/dwm ~/.config/suckless
    cp -rf ~/Git/dunstrc/* ~/.config/dunst
    cp -fr ~/Git/nirucon-suckless/nirucon-greeter ~/.config/
    sudo cp -fr ~/Git/nirucon-suckless/fonts/* /usr/share/fonts/

    declare -a suckless_dirs=("dwm" "dmenu" "slock" "st")
    for dir in "${suckless_dirs[@]}"; do
        sudo make -C ~/.config/suckless/$dir clean install
    done

    cp -f ~/Git/nirucon-suckless/.xinitrc ~/
    cp -f ~/Git/nirucon-suckless/autostart.sh ~/.dwm
    cp -f ~/Git/nirucon-suckless/.bashrc ~/
    cp -f ~/Git/nirucon-suckless/.bash_aliases_void ~/
    cp -rf ~/Git/nirucon-suckless/nirucon-wallpapers ~/Pictures/
    sudo cp -f ~/Git/nirucon-suckless/issue /etc/
    chmod +x ~/.dwm/autostart.sh ~/.config/suckless/nirubar-dwm-void/nirubar-dwm-void ~/.config/nirucon-greeter/greeter

    # Insert nirubar-dwm in .xinitrc
    line_to_insert="~/.config/suckless/nirubar-dwm-arch/nirubar-dwm-void &"
    comment_line="# Start nirubar-dwm-*"
    if [[ -f ~/.xinitrc ]]; then
        sed -i "/$comment_line/a $line_to_insert" ~/.xinitrc
        echo "Line inserted successfully."
    else
        echo "~/.xinitrc not found. Please ensure you have the file in your home directory."
    fi

    # srplay-dmenu - dmenu script for SR play podcasts and radio
    echo "Cloning and installing the 'srplay-dmenu' script..."
    rm -rf ~/Git/srplay-dmenu
    git clone https://github.com/nirucon/srplay-dmenu ~/Git/srplay-dmenu
    sudo cp -f ~/Git/srplay-dmenu/srplay-dmenu /usr/local/bin/
    sudo chmod +x /usr/local/bin/srplay-dmenu
    rm -rf ~/Git/srplay-dmenu

    # dwmexit-dmenu - dmenu script for suspend, logout, restart, reboot
    # placeholder

    # havamal - script for random quotes in .bashrc
    echo "Installing havamal script..."
    rm -rf ~/Git/havamal
    git clone https://github.com/nirucon/havamal ~/Git/havamal
    mkdir -p ~/.config/havamal
    cp -fr ~/Git/havamal/* ~/.config/havamal/
    chmod +x ~/.config/havamal/havamal
    rm -rf ~/Git/havamal
    echo "The 'havamal' script has been installed and the repository has been removed."

    echo "nirucon-suckless, configurations and scripts installed successfully."
}

# Function: Prompt for reboot
prompt_reboot() {
    read -p "Nirucon-VLPI is now installed. Start with: startx, but it's highly recommended to reboot. Do you want to reboot now? [Y/n]: " reboot_choice
    reboot_choice="${reboot_choice,,}"
    if [[ "$reboot_choice" =~ ^(yes|y| ) ]] || [[ -z "$reboot_choice" ]]; then
        sudo reboot
    fi
}

# Main function
main() {
    display_welcome
    check_internet_connection
    confirm_proceed
    install_repos
    install_core_suckless
    install_suckless
    prompt_reboot
}

# Run the main function
main
